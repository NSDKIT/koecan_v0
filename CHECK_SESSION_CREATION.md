# セッション作成の確認方法

## 問題の整理

- **クライアント側**（`LineLinkButton.tsx`）: `NEXT_PUBLIC_SUPABASE_ANON_KEY`を使用 → RLSポリシーの影響を受ける
- **サーバー側**（`app/api/line/callback/route.ts`）: `SUPABASE_SERVICE_ROLE_KEY`を使用 → RLSポリシーをバイパス

`SUPABASE_SERVICE_ROLE_KEY`を使っている場合、RLSポリシーはバイパスされるはずなので、セッションが見つからないということは、**セッションが正しく保存されていない**可能性が高いです。

## 確認手順

### 1. ブラウザのコンソールで確認

1. 開発者ツール（F12）を開く
2. 「Console」タブを選択
3. LINE連携ボタンをクリック
4. 以下のログを確認：

**成功している場合**:
```
セッション作成を試行中... { token: 'xxxxxxxx...', userId: '...', expiresAt: '...' }
セッション作成成功: [{ id: '...', token: '...', user_id: '...', expires_at: '...' }]
```

**失敗している場合**:
```
セッション作成失敗 - 詳細: { message: '...', code: '...', ... }
```

### 2. セッション作成が失敗している場合

#### エラーコード `42P01`: テーブルが存在しない

**解決方法**:
1. SupabaseのSQL Editorで`create_line_link_sessions_table.sql`を実行
2. テーブルが作成されたことを確認
3. LINE連携を再度試行

#### エラーコード `42501`: RLSポリシーエラー

**解決方法**:
1. SupabaseのSQL Editorで`fix_line_link_sessions_rls.sql`を実行
2. 特に以下のポリシーが存在することを確認：
   - `Users can insert own line link sessions` (INSERT, authenticated)
   - `Service role can manage all line link sessions` (ALL, service_role)
3. LINE連携を再度試行

### 3. セッション作成が成功している場合

セッションが正しく作成されているのに、サーバー側で見つからない場合は、以下を確認：

#### トークンの不一致

1. ブラウザのコンソールで、セッション作成時のトークンを確認
2. Vercelのログで、セッション検索時のトークンを確認
3. 両者が一致しているか確認

**確認方法**:
- ブラウザのコンソール: `セッション作成成功:` のログでトークンを確認
- Vercelのログ: `セッション検索開始:` のログでトークンを確認

#### テーブル内のデータを確認

SupabaseのSQL Editorで以下を実行：

```sql
-- 最新のセッションデータを確認
SELECT 
    token,
    user_id,
    expires_at,
    created_at,
    CASE 
        WHEN expires_at < now() THEN '❌ 期限切れ'
        ELSE '✅ 有効'
    END AS status
FROM 
    line_link_sessions
ORDER BY 
    created_at DESC
LIMIT 10;
```

**データが存在する場合**: トークンの不一致の可能性が高い
**データが存在しない場合**: セッションが正しく保存されていない（RLSポリシーの問題）

## よくある問題と解決方法

### 問題1: セッション作成時にRLSポリシーエラー

**症状**: ブラウザのコンソールに「セッション作成失敗」が表示される

**原因**: RLSポリシーが正しく設定されていない

**解決方法**:
1. `fix_line_link_sessions_rls.sql`を実行
2. 特に`Users can insert own line link sessions`ポリシーが存在することを確認
3. ポリシーの`WITH CHECK`句が`user_id = auth.uid()`になっていることを確認

### 問題2: セッションは作成されるが、サーバー側で見つからない

**症状**: ブラウザのコンソールでは「セッション作成成功」が表示されるが、サーバー側で「セッションが見つかりません」エラー

**原因**: トークンの不一致またはテーブルへのアクセス権限の問題

**解決方法**:
1. ブラウザのコンソールとVercelのログで、トークンが一致しているか確認
2. `state`パラメータのエンコード/デコードが正しく行われているか確認
3. テーブル内のデータを確認（上記のSQLを実行）

### 問題3: テーブルが存在しない

**症状**: エラーコード `42P01` または `PGRST116`

**解決方法**:
1. `create_line_link_sessions_table.sql`を実行
2. テーブルが作成されたことを確認
3. LINE連携を再度試行

## デバッグの流れ

1. **ブラウザのコンソールで確認**
   - LINE連携ボタンをクリック
   - 「セッション作成成功」が表示されるか確認
   - 表示されない場合は、エラーメッセージを確認

2. **エラーコードに応じて対処**
   - `42P01`: テーブルを作成
   - `42501`: RLSポリシーを修正

3. **セッション作成が成功している場合**
   - Vercelのログで、サーバー側のトークンと一致しているか確認
   - テーブル内のデータを確認

4. **問題が解決しない場合**
   - ブラウザのコンソールとVercelのログの両方を確認
   - エラーメッセージとエラーコードを共有してください

